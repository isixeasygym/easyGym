<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="com.isix.easyGym.detail.dao.DetailDAO"> 

	<resultMap type="detailDTO" id="detailResult">
 		<result property="detailNo" column="detailNo"/>
 		<result property="detailDate" column="detailDate"/>
 		<result property="detailRoadAddress" column="detailRoadAddress"/>
 		<result property="detailBusinessName" column="detailBusinessName"/>
 		<result property="detailBusinessEng" column="detailBusinessEng"/>
 		<result property="detailDailyTicket" column="detailDailyTicket"/>
 		<result property="detailMonthlyTicket" column="detailMonthlyTicket"/>
 		<result property="detailScope" column="detailScope"/>
 		<result property="detailComment" column="detailComment"/>
 		<result property="detailServiceProgram" column="detailServiceProgram"/>
 		<result property="detailStatus" column="detailStatus"/>
 		<result property="detailClassification" column="detailClassification"/>
 		<result property="detailFreeService" column="detailFreeService"/>
 		<result property="detailMonthlyPrice" column="detailMonthlyPrice"/>
 		<result property="detailKoClassification" column="detailKoClassification"/>
 		<result property="detailLatitude" column="detailLatitude"/>
 		<result property="detailLongitude" column="detailLongitude"/>
 		<result property="operatorNo" column="operatorNo"/>
 	</resultMap>
 	
 	<resultMap type="detailDibsDTO" id="detailDibsResult">
 		<result property="dibsNo" column="dibsNo"/>
 		<result property="detailNo" column="detailNo"/>
 		<result property="memberNo" column="memberNo"/>
 	</resultMap>
 	
 	<resultMap type="detailReviewDTO" id="detailReviewResult">
 		<result property="reviewNo" column="reviewNo"/>
 		<result property="reviewComment" column="reviewComment"/>
 		<result property="reviewImgName" column="reviewImgName"/>
 		<result property="reviewDate" column="reviewDate"/>
 		<result property="reviewRating" column="reviewRating"/>
 		<result property="memberNo" column="memberNo"/>
 		<result property="buyNo" column="buyNo"/>
 		<result property="detailNo" column="detailNo"/>
 	</resultMap>
 	
 	<resultMap type="detailImageDTO" id="detailImageResult">
 		<result property="imageFileNo" column="imageFileNo"/>
 		<result property="imageFileName" column="imageFileName"/>
 		<result property="regDate" column="regDate"/>
 		<result property="detailNo" column="detailNo"/>
 	</resultMap>

	<select id="selectQuery" parameterType="java.util.Map" resultMap="detailResult">
	    <![CDATA[
	        SELECT * FROM detail_tbl
	        WHERE detailRoadAddress LIKE CONCAT('%', #{query}, '%')
	        AND detailClassification = #{detailClassification}
	    ]]>
	</select>

 	<select id="selectBusiness" parameterType="int" resultType="detailDTO">
		<![CDATA[
 			select * from detail_tbl where detailNo = #{detailNo}
 		]]>
	</select>	
 		
 	<select id="getNewDetailNo" resultType="int" >
		<![CDATA[
 			select IFNULL(Max(articleNo),0)+1 from detail_tbl 
 		]]>
	</select>	
 		
 	<select id="selectAll" parameterType="String" resultType="detailDTO" >
		<![CDATA[
 			select * from detail_tbl where detailClassification = #{detailClassification} 
 		]]>
	</select>
	
	<select id="selectPopular" parameterType="int" resultType="detailDTO">
		<![CDATA[
 			select * from detail_tbl where detailNo = #{popularRating} 
 		]]>
	</select>
	
	<select id="selectReview" parameterType="int" resultMap="detailReviewResult">
		<![CDATA[
 			select * from detailreview_tbl where detailNo = #{detailNo}
 		]]>
	</select>
	
 	<select id="selectPopularRating" parameterType="int" resultType="int" >
		<![CDATA[
 			SELECT detailNo, SUM(reviewRating) as totalRating FROM reviews GROUP BY detailNo ORDER BY totalRating DESC LIMIT 5 where detailNo = {detailNum} ;
 		]]>
	</select>
 	
 	<select id="selectDetailNo" parameterType="String" resultType="int" >
		<![CDATA[
 			selct detailNo from detail_tbl where detailClassification = #{detailClassification}
 		]]>
	</select>
 	
 	<select id="findDibs" parameterType="java.util.Map" resultMap="detailDibsResult">
		<![CDATA[
 			select * from detaildibs_tbl where detailNo = #{detailNo} and memberNo = #{memberNo}
 		]]>
	</select>
 
 		<!--<![CDATA[
 			select reviewNo from detailreview_tbl where detailNo=#{detailNo}
 		]]>-->		
 
 	<select id="selectReviewNo" parameterType="int" resultType="int">
 		<![CDATA[
 			SELECT reviewNo FROM detailreview_tbl WHERE detailNo = #{detailNo}
			UNION ALL SELECT 0 WHERE NOT EXISTS ( SELECT 1 FROM detailreview_tbl WHERE detailNo = #{detailNo})
 			
 		]]>
 	</select>
 	
 	<insert id="insertDibs" parameterType="java.util.Map">
 		<![CDATA[ 
 			insert into detaildibs_tbl (detailNo, memberNo) values(#{detailNo},#{memberNo})
 		]]>
 	</insert>
 	
 	<insert id="insertReview" parameterType="java.util.Map">
 		<![CDATA[ 
 			insert into detailreview_tbl (reviewComment,reviewImgName, reviewDate,reviewRating,memberNo, buyNo, detailNo) values(#{reviewComment},#{reviewImgName},sysDate(),#{reviewRating},#{memberNo},#{buyNo},#{detailNo})
 		]]>
 	</insert>
 	
 	<insert id="insertNoImgReview" parameterType="java.util.Map">
 		<![CDATA[ 
 			insert into detailreview_tbl (reviewComment, reviewDate,reviewRating,memberNo, buyNo,detailNo) values(#{reviewComment},sysDate(),#{reviewRating},#{memberNo},#{buyNo},#{detailNo})
 		]]>
 	</insert>
 	
 	<insert id="insertOperForm" parameterType="java.util.Map">
 		<![CDATA[
 			insert into detail_tbl values(#{detailNo},sysdate(),#{detailRoadAddress},#{detailBussinessName},
 			#{detailBusinessName},#{detailBusinessEng},#{detailDailyTicket},#{detailMonthlyTicket},#{detailComment},
 			#{detailServiceProgram},#{detailClassification},#{detailFreeService},#{detailMonthlyPrice},
 			#{detailKoClassification}, #{detailLatitude}, #{detailLongitude}, #{operatorNo})
 		]]>
 	</insert>
 	
 	<insert id="insertNewImages" parameterType="java.util.Map">
 		insert into imagefile_tbl values
 		<foreach collection="imageFileList" item="item" separator=",">
 			(#{item.imageFileNo}, #{item.imageFileName}, sysdate(), #{detailNo})
 		</foreach>
 	</insert>
 	
 	<delete id="deleteReview" parameterType="int">
 		<![CDATA[
 			delete from detaildibs_tbl where reviewNo = #{reviewNo}
 		]]>
 	</delete>
 	
 	<delete id="removeDibs" parameterType="java.util.Map">
 		<![CDATA[
 			delete from detaildibs_tbl where memberNo=#{memberNo} and detailNo = #{detailNo}
 		]]>
 	</delete>
  </mapper>